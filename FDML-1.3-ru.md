# FDML Specification v1.3 — Полная спецификация

## 1. Введение

**FDML (Feature-Driven Modeling Language)** — доменно-специфический язык для формального описания систем, сущностей, бизнес-правил и пользовательских сценариев.  
Цель — обеспечить единую платформу для общения бизнеса и разработчиков с одновременной возможностью автоматизации тестирования и генерации кода.

FDML объединяет идеи BDD и DDD, структурируя описание так, чтобы:
- быть читаемым для бизнес-пользователей;
- быть формальным и однозначным для разработки и автоматизации;
- обеспечивать трассируемость и расширяемость.

---

## 2. Основные понятия и структура языка

Язык основан на наборе ключевых понятий:

| Понятие       | Описание                                                    |
|---------------|-------------------------------------------------------------|
| system        | Описывает высокоуровневую систему и ее компоненты           |
| entity        | Определяет структуру и ограничения данных                    |
| action        | Описывает операции и поведение с входными и выходными данными|
| feature       | Определяет пользовательские требования и сценарии поведения |
| flow          | Определяет последовательность действий (workflow)           |
| constraint    | Бизнес-правила и ограничения                                 |
| traceability  | Связи и трассируемость между элементами                      |
| generation_rule | Правила генерации и зависимости между элементами           |

---

## 3. Система (system)

### 3.1 Назначение
Определяет контекст — совокупность взаимосвязанных компонентов, подсистем и их взаимодействие.

### 3.2 Структура

```yaml
system:
  id: string             # Уникальный идентификатор системы
  name: string           # Человеко-читаемое имя системы
  description: string    # Краткое описание
  components:            # Список компонентов или подсистем
    - string             # Идентификатор компонента
  relationships:         # Определение связей между компонентами
    - from: string       # Исходный компонент
      to: string         # Целевой компонент
      type: string       # Тип связи (например, "зависимость", "поток данных")
      description: string # Опционально — описание связи
```

### 3.3 Допустимые типы связей (рекомендуется):

* dependency — зависимость
* data\_flow — поток данных
* control\_flow — управление
* event — событие

---

## 4. Сущности (entity)

### 4.1 Назначение

Определяют структуру данных и их ограничения.

### 4.2 Синтаксис

```yaml
entity:
  id: string            # Уникальный идентификатор
  name: string          # Имя сущности
  description: string   # Описание сущности
  fields:               # Список полей
    - name: string      # Имя поля
      type: <data_type> # Тип данных
      required: bool    # Обязательное ли поле
      description: string # Описание поля
      default: any      # Значение по умолчанию (опционально)
      constraints:      # Список ограничений (опционально)
        - string|dict   # Например, "unique", {"max_length": 255}
  indexes:              # Индексы для оптимизации поиска (опционально)
    - fields: [string]  # Поля для индексации
      unique: bool      # Уникальный индекс
```

### 4.3 Поддерживаемые типы данных

| Тип      | Описание                                | Пример                                 |
| -------- | --------------------------------------- | -------------------------------------- |
| string   | Строка                                  | "text"                                 |
| integer  | Целое число                             | 42                                     |
| float    | Число с плавающей точкой                | 3.1415                                 |
| boolean  | Логический тип (true/false)             | true                                   |
| datetime | Дата и время в формате ISO 8601         | "2025-07-23T14:25:43Z"                 |
| date     | Только дата                             | "2025-07-23"                           |
| array    | Массив элементов определенного типа     | \[1,2,3]                               |
| object   | Вложенный объект (словарь)              | { "key": "value" }                     |
| enum     | Перечисление значений (строк или чисел) | "RED", "GREEN", "BLUE"                 |
| uuid     | Уникальный идентификатор (UUID)         | "550e8400-e29b-41d4-a716-446655440000" |

### 4.4 Ограничения полей (constraints)

* **unique** — уникальность значения в рамках сущности
* **max\_length** — максимальная длина строки
* **min\_length** — минимальная длина строки
* **max\_value** — максимальное числовое значение
* **min\_value** — минимальное числовое значение
* **pattern** — регулярное выражение для строк
* **nullable** — допускается null (false по умолчанию)
* **default** — значение по умолчанию

---

## 5. Действия (action)

### 5.1 Назначение

Определяют поведение и операции над сущностями или системой.

### 5.2 Структура

```yaml
action:
  id: string
  name: string
  description: string
  input:                   # Входные параметры
    - name: string
      type: <data_type>
      required: bool
  output:                  # Выходные данные
    - name: string
      type: <data_type>
  logic: string            # Псевдокод, описание алгоритма или ссылка на реализацию
  exceptions:              # Исключения/ошибки, которые могут возникнуть
    - code: string
      message: string
```

### 5.3 Пример

```yaml
action:
  id: create_candidate
  name: "Создать кандидата"
  description: "Добавление нового кандидата в систему"
  input:
    - name: candidate_data
      type: object
      required: true
  output:
    - name: success
      type: boolean
  logic: |
    Проверить уникальность email
    Сохранить данные кандидата
    Вернуть success=true
  exceptions:
    - code: "ERR_DUPLICATE_EMAIL"
      message: "Email уже используется"
```

---

## 6. Фичи (feature)

### 6.1 Назначение

Определяют пользовательские требования и ожидаемое поведение системы.

### 6.2 Структура

BDD-стиль с использованием ключевых слов:

```gherkin
Feature: <Название фичи>
  Description: <Описание>

  Scenario: <Название сценария>
    Given <начальное состояние>
    When <действие>
    Then <ожидаемый результат>
    And <дополнительные условия>
```

### 6.3 Правила написания

* Использовать ясный, читаемый язык, максимально близкий к бизнес-домену.
* Не упоминать технические детали или UI-элементы.
* Каждый сценарий должен быть независим и фокусироваться на одной бизнес-логике.

---

## 7. Потоки (flow)

### 7.1 Назначение

Определяют последовательности действий и возможные переходы.

### 7.2 Синтаксис

```yaml
flow:
  id: string
  name: string
  steps:
    - action_id: string              # Идентификатор действия для выполнения
      on_success_action_id: string   # ID следующего действия при успехе
      on_failure_action_id: string   # ID следующего действия при ошибке (опционально)
```

---

## 8. Ограничения (constraint)

### 8.1 Назначение

Бизнес-правила, которые накладываются на сущности, действия или фичи.

### 8.2 Структура

```yaml
constraint:
  id: string
  name: string
  description: string
  applies_to:                # К чему применяется: entity_id, action_id, feature_id
    - string
  condition: string          # Условие в DSL (выражение)
  message: string            # Сообщение об ошибке при нарушении
```

### 8.3 Пример

```yaml
constraint:
  id: unique_email
  name: "Уникальность email"
  description: "Email кандидата должен быть уникален"
  applies_to:
    - candidate
  condition: "email is unique"
  message: "Email уже используется"
```

---

## 9. Трассируемость (traceability)

### 9.1 Назначение

Обеспечивает связь и следование между требованиями, действиями, сущностями и тестами.

### 9.2 Синтаксис

```yaml
traceability:
  from: string      # ID исходного элемента (например, feature)
  to: string        # ID связанного элемента (например, action)
  relation: string  # Тип связи (implements, verifies, depends_on)
```

---

## 10. Правила генерации и зависимости (generation\_rule, feature\_dependency)

### 10.1 Правила генерации

Определяют автоматическую трансформацию или создание элементов.

```yaml
generation_rule:
  target: string         # ID элемента
  rule: string           # Описание правила генерации
```

### 10.2 Зависимости фич

Определяют, какие фичи должны быть реализованы ранее.

```yaml
feature_dependency:
  feature: string        # ID фичи, которая зависит
  depends_on: string     # ID фичи, от которой зависит
```

---

## 11. Формат и типы файлов

* Основной формат — YAML для структурных описаний.
* Текстовые BDD-фичи — в формате Gherkin (.feature).
* Возможна интеграция с JSON или XML при необходимости.

---

## 12. Дополнения

* Поддержка мультиязычности описаний.
* Возможность вложенности сущностей и компонентов.
* Расширяемость через пользовательские типы и аннотации.

---

## 13. Хранение, версионирование и соответствие реализации

### 13.1 Хранение спецификаций

FDML спецификации хранятся в формате, поддерживающем:

- Многофайловую структуру, где каждая сущность, фича, система и т.п. — отдельный файл или набор файлов.  
- Иерархическую организацию (папки, namespaces), отражающую бизнес-структуру проекта.  
- Стандартизированные форматы: YAML для структурированных сущностей, Gherkin (.feature) для BDD сценариев, дополнительные форматы (JSON, XML) для интеграций.  

Это облегчает поддержку, автоматическое парсирование и интеграцию с системами CI/CD.

### 13.2 Версионирование

#### 13.2.1 Основные принципы

- Каждая версия спецификации фиксируется с уникальным идентификатором (например, `v1.3.0`).  
- Версии отражают изменения в структуре модели, бизнес-логике, требованиях или реализации.  
- Изменения сопровождаются описанием в release notes с детализацией по затронутым сущностям, добавленным или удалённым полям, новым сценариям и т.п.  

#### 13.2.2 Типы изменений

- **Patch (исправления)** — уточнения описаний, не влияющие на структуру.  
- **Minor (непринципиальные добавления)** — новые сущности или поля без нарушения совместимости.  
- **Major (принципиальные изменения)** — несовместимые изменения, удаление или переработка ключевых элементов.  

#### 13.2.3 Ведение истории

- История изменений хранится в системе контроля версий (Git или аналог).  
- Используются стандартизированные commit-сообщения и шаблоны pull request для трассируемости.  
- Связь изменений кода и спецификации осуществляется через issue ID, feature ID и другие метаданные.

### 13.3 Отслеживание изменений по типам сущностей

| Сущность         | Что отслеживать                                               |
|------------------|--------------------------------------------------------------|
| system           | Изменения в составе, связях, описаниях                        |
| entity           | Добавление/удаление полей, изменение типов, ограничений      |
| action           | Изменения параметров, логики, ошибок                          |
| feature          | Новые или изменённые сценарии, acceptance criteria            |
| flow             | Последовательности, ветвления                                  |
| constraint       | Правила и условия                                            |
| traceability     | Связи между элементами                                        |
| generation_rule  | Логика генерации                                              |
| feature_dependency | Зависимости                                                |

При фиксации версии спецификации документируется перечень изменённых сущностей с описанием сути изменений.

### 13.4 Связь спецификации и реализации

#### 13.4.1 Концепция

- Спецификация описывает поведение и структуру, которые должны быть реализованы в коде.  
- Код — набор классов и методов, должен соответствовать требованиям спецификации.  
- Для проверки соответствия используют статический и динамический анализ, сопоставляющий код и спецификацию.

#### 13.4.2 Подходы

- Генерация шаблонов кода из спецификаций (интерфейсы, классы).  
- Автоматизация тестирования с BDD-фреймворками (Cucumber, Behave).  
- Связывание версий кода и спецификаций через систему контроля версий.  
- Трассируемость требований через элементы `traceability`.

### 13.5 Примечания и рекомендации

- Версионирование — обязательный элемент жизненного цикла модели.  
- История изменений обеспечивает воспроизводимость и аудит.  
- Рекомендуется использовать CI/CD для валидации спецификаций и запуска автоматических тестов.  
- В будущем FDML может расширяться атрибутами для поддержки проверки реализации (например, `implementation_reference`, `test_coverage`).

---

## 14. Расширение 1.3.1: Механизм трассируемости через метаинформацию

### 14.1 Цель

FDML 1.3 описывает структуру фич в формате Gherkin, позволяя описывать бизнес-функциональность в виде сценариев. Однако, в данной версии отсутствует структурированная трассируемость между:

• фичами (feature)
• действиями (actions)
• реализациями (endpoints, workflows, сервисами)
• бизнес-требованиями / системными требованиями

Цель данной спецификации — ввести структурированный внешний механизм трассируемости, не нарушающий читаемость .feature-файлов и дополняющий их связями через YAML-файлы метаинформации.

### 14.2 Компоненты

#### 14.2.1 *.feature — основной Gherkin-файл

Без изменений. Содержит описание фич и сценариев.

Пример:

```gherkin
Feature: Управление статьями

  Scenario: Создание новой статьи
    Given пользователь авторизован
    When он отправляет корректные данные
    Then создается статья с ID

  Scenario: Удаление статьи
    Given статья существует
    When пользователь отправляет DELETE
    Then статья удаляется
```

#### 14.2.2 *.feature.meta.yaml — метаинформация о фиче

Метафайл описывает структуру, идентификаторы, связи и сценарии. Он размещается рядом с .feature.

Структура:

```yaml
feature:
  id: <уникальный_идентификатор>
  name: <название_фичи>
  description: <описание>
  file: <имя_файла_с_фичей>
  
  scenarios:
    - id: <уникальный_идентификатор_сценария>
      title: <человекочитаемое_название>
      line: <номер_строки_в_feature>
      action: <id_действия>
      traceability:
        - to: <id_целевого_объекта>
          relation: <тип_связи>  # например: implements, verifies, tests, blocks
```

Пример:

```yaml
feature:
  id: article_crud
  name: Управление статьями
  description: Создание, просмотр и удаление статей
  file: article_crud.feature
  
  scenarios:
    - id: article_create
      title: Создание новой статьи
      line: 3
      action: create_article
      traceability:
        - to: BR-12
          relation: implements
        - to: API-POST-/articles
          relation: verifies

    - id: article_delete
      title: Удаление статьи
      line: 8
      action: delete_article
      traceability:
        - to: BR-13
          relation: implements
        - to: API-DELETE-/articles/{id}
          relation: verifies
```

#### 14.2.3 traceability.yaml (опционально)

Формируемый автоматически. Может быть агрегирован из всех *.meta.yaml файлов.

```yaml
traceability:
  - from: article_create
    to: BR-12
    relation: implements
  - from: article_create
    to: API-POST-/articles
    relation: verifies
```

### 14.3 Спецификация типов relation

| Тип связи    | Назначение                                                           |
|--------------|----------------------------------------------------------------------|
| implements   | Сценарий реализует бизнес-требование или функциональность            |
| verifies     | Проверяет/покрывает API, workflow, UI                                |
| tests        | Является автотестом на указанную сущность                            |
| blocks       | Блокирует выполнение/релиз, пока не реализовано                      |
| depends_on   | Сценарий зависит от другой реализации или ресурса                    |

### 14.4 Правила валидации

1. Каждый .meta.yaml должен ссылаться на существующий .feature через file.
2. Каждый line должен указывать на реально существующий Scenario.
3. ID фич и сценариев уникальны в пределах проекта.
4. Все traceability.to должны ссылаться на существующие action/BR/API (если проверка включена).
5. Метафайлы обязательны только для тех фич, у которых есть бизнес-связи или автотесты.

### 14.5 Пример использования

1. Автоматическая генерация матрицы покрытия:
• Какие бизнес-требования покрыты
• Какие endpoints протестированы

2. Валидация CI/CD:
• Проверка соответствия .feature и .meta.yaml
• Отображение покрытия по API/BR

3. Генерация документации:
• Для аналитиков, QA, архитекторов

### 14.6 Возможные утилиты

• fdml-trace validate: валидирует *.meta.yaml
• fdml-trace graph: строит graphviz-диаграмму связей
• fdml-trace matrix: CSV или Markdown-матрицу покрытия

### 14.7 Заключение

Данное расширение FDML 1.3.1 обеспечивает:
• Поддержку сквозной трассируемости (end-to-end traceability)
• Независимость структуры от Gherkin-синтаксиса
• Полную машинную обработку и анализ покрытия
• Сохранение привычной читаемости сценариев для команды

Это расширение совместимо с существующими .feature и может быть внедрено поэтапно, начиная с наиболее критичных бизнес-фич.

---

## 15. Расширение 1.3.2: Механизм миграций (FDML Migrations)

### 15.1 Цель расширения

Обеспечить системный, контролируемый и формализованный механизм управления изменениями (миграциями) в рамках FDML-моделей:

- для фич (feature),
- для сущностей (entity),
- для действий (action),
- и связанных с ними компонентов.

Это позволяет:

- фиксировать изменения во времени,
- обеспечивать обратимость (rollback),
- верифицировать согласованность состояния,
- интегрировать с системой генерации кода и CI/CD.

### 15.2 Общее описание

#### 15.2.1 Понятие миграции

Миграция — это атомарный набор изменений, описанных декларативно, который приводит состояние модели FDML из одной версии в другую.

Миграции хранятся как файлы с уникальными идентификаторами (например, timestamp или семантический номер) и имеют две основные части:

- **up** — операции, применяющие изменения;
- **down** — операции, отменяющие изменения.

### 15.3 Формат миграции

#### 15.3.1 Структура YAML-манифеста миграции

```yaml
id: string               # Уникальный идентификатор миграции (например, дата и порядковый номер)
author: string           # Автор миграции
date: ISO8601            # Дата создания миграции
description: string      # Краткое описание миграции

up:                     # Операции для применения миграции
  - <operation>:        # Одна из операций из списка (см. ниже)
      <params>: ...     

down:                   # Операции для отката миграции (обратные к up)
  - <operation>:
      <params>: ...
```

#### 15.3.2 Поддерживаемые операции миграций

| Операция           | Описание                                                                                  | Пример параметров                                       |
|--------------------|-------------------------------------------------------------------------------------------|--------------------------------------------------------|
| `add_feature`      | Добавить новую фичу                                                                        | `id`, `title`, `entity`, `operation`, `roles`          |
| `remove_feature`   | Удалить существующую фичу                                                                 | `id`                                                    |
| `modify_feature`   | Изменить атрибуты существующей фичи                                                      | `id`, `fields` (указываются изменённые поля)            |
| `add_entity`       | Добавить новую сущность                                                                   | `id`, `fields`                                          |
| `remove_entity`    | Удалить сущность                                                                          | `id`                                                    |
| `modify_entity`    | Изменить структуру сущности                                                               | `id`, `fields`                                          |
| `add_action`       | Добавить действие                                                                         | `id`, `description`, `input`, `output`                  |
| `remove_action`    | Удалить действие                                                                          | `id`                                                    |
| `modify_action`    | Изменить действие                                                                        | `id`, `fields`                                          |
| `add_constraint`   | Добавить ограничение                                                                     | `id`, `condition`, `applies_to`, `message`              |
| `remove_constraint`| Удалить ограничение                                                                     | `id`                                                    |
| `modify_constraint`| Изменить ограничение                                                                    | `id`, `fields`                                          |

### 15.4 Пример миграции

```yaml
id: 2025_07_24_001_add_crud_user
author: ara
date: 2025-07-24T12:00:00Z
description: Добавлены CRUD-фичи для сущности User

up:
  - add_feature:
      id: user.create
      title: Создание пользователя
      entity: user
      operation: create
      roles: [admin]

  - add_feature:
      id: user.read
      title: Просмотр пользователя
      entity: user
      operation: read
      roles: [admin, support]

down:
  - remove_feature:
      id: user.create

  - remove_feature:
      id: user.read
```

### 15.5 Управление миграциями

- Миграции хранятся в отдельной папке (например, `fdml_migrations/`).
- Каждая миграция — отдельный YAML-файл с уникальным `id`.
- Состояние модели FDML отслеживается с помощью файла состояния (`fdml_migration_state.json`), в котором хранится список применённых миграций.
- Инструмент управления миграциями (CLI/скрипт) поддерживает команды:
  - `upgrade` — применить все новые миграции;
  - `downgrade` — откатить последнюю миграцию;
  - `status` — показать текущее состояние и доступные миграции;
  - `validate` — проверить целостность и согласованность модели после миграций.

### 15.6 Взаимодействие с другими компонентами FDML

- При применении миграций автоматически обновляются соответствующие `.feature`, `.entity` и другие определения.
- Генерация кода и тестов привязывается к конкретной версии модели, соответствующей текущему состоянию миграций.
- Система версионирования и трассируемости `traceability` может использовать данные миграций для построения динамического роадмапа и аудита.

### 15.7 Валидация и целостность

- Миграции должны выполняться в строгом порядке.
- Запрещены циклические зависимости и пропуски миграций.
- Перед применением миграции запускается проверка согласованности модели.
- При ошибках происходит откат миграции.

### 15.8 Итог

FDML 1.3.2 вводит мощный и прозрачный механизм управления эволюцией моделей, базирующийся на миграциях по образу Alembic. Это расширение:

- улучшает контроль версий и истории изменений,
- облегчает поддержку и развитие проектов,
- обеспечивает интеграцию с автоматизацией генерации и тестирования.

---

# Приложение: Таблица типов данных

| Тип      | Формат значения                   | Описание                                |
| -------- | --------------------------------- | --------------------------------------- |
| string   | Строка                            | Текстовые данные                        |
| integer  | Целое число                       | Для числовых идентификаторов, счетчиков |
| float    | Число с плавающей точкой          | Для дробных чисел                       |
| boolean  | true / false                      | Логическое значение                     |
| datetime | ISO 8601 "YYYY-MM-DDTHH\:MM\:SSZ" | Дата и время                            |
| date     | "YYYY-MM-DD"                      | Только дата                             |
| array    | Список однотипных элементов       | Коллекция элементов                     |
| object   | Ключ-значение                     | Вложенный объект                        |
| enum     | Строка из фиксированного набора   | Перечисление значений                   |
| uuid     | Строка в формате UUID             | Уникальный идентификатор                |

---

# Заключение

Данная спецификация служит исчерпывающим, формальным и практичным руководством по описанию предметной области, поведения и бизнес-логики с помощью FDML v1.3.
Она ориентирована на максимальную читабельность, исполняемость и междисциплинарное взаимодействие.

Спецификация включает основную версию 1.3, а также расширения:
- 1.3.1 — механизм трассируемости через внешнюю метаинформацию
- 1.3.2 — механизм миграций для управления изменениями модели

Эти расширения обеспечивают полноценную поддержку жизненного цикла разработки, от требований до реализации и поддержки.